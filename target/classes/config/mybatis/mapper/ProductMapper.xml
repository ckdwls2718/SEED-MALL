<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.product.mapper.ProductMapper">

	<insert id="productInsert" parameterType="ProductF" useGeneratedKeys="true" keyProperty="pidx">
		
		insert into product(pidx,upCg_code,downCg_code,pname,price,
		psaleprice,pqty,ppoint,pspec,pcontent,pdate,preadnum,plikenum)
		values(product_seq.nextval,#{upCg_code},#{downCg_code},#{pname},
		#{price},#{psaleprice},#{pqty},#{ppoint},#{pspec},
		#{pcontent:VARCHAR},sysdate,#{preadnum},#{plikenum})
		
		<selectKey keyProperty="pidx" resultType="int" order="AFTER">
			select product_seq.currval from dual
		</selectKey>
	</insert>
	
	<insert id="insertPimage" parameterType="ProductI">
		insert into product_image(image_pidx, pidx, pThumbnail, pimage, pOriginFilename)
		values(product_image_seq.nextval, #{pidx},#{pThumbnail:VARCHAR},#{pimage},#{pOriginFilename})
	</insert>
	
	
	<select id="getProducts" resultType="Product" parameterType="Paging">
		<include refid="selectProd"/>
		<include refid="findProdWhere"/>
		<include refid="prodSort"/>
	</select>
	
	<select id="getProductImg" resultType="ProductI">
		select * from product_image order by image_pidx desc
	</select>
	
	
	<select id="getProdImages" resultType="ProductI" parameterType="_int">
		select *
		from product_image
		where pidx=#{value}
		order by 1 asc
	</select>
	
	<select id="selectByPspec" resultType="Product" parameterType="string">
		<include refid="selectProd"/>
		where pspec=#{value}
	</select>
	
	<select id="selectByPidx" resultType="Product" parameterType="_int">
		<include refid="selectProd"/>
		where pidx=#{value}
	</select>
	
	<sql id="selectProd">
		select p.*,decode(c.upcg_code,1,'초보',2,'중급',3,'전문가') upcg_name,c.downCg_name
		from product p join downcategory c 
		on p.downCg_code = c.downCg_code and p.upCg_code =c.upCg_code
	</sql>
	
	<sql id="findProdWhere">
		<if test="upcg!=null and upcg!=''">
			<where>
				p.upcg_code = #{upcg}
			</where>
		</if>
		<if test="downcg!=null and downcg!=''">
			and p.downcg_code = #{downcg}
		</if>
		<if test="findKeyword!=null and findKeyword!=''">
			<where>
				p.pname like '%'||#{findKeyword}||'%'
			</where>
		</if>
	</sql>
	
	<sql id="prodSort">
		<if test="sort!=null and sort!=''">
			<if test="sort==1">
				order by pidx desc
			</if>
			<if test="sort==2">
				
			</if>
			<if test="sort==3">
				order by price desc, pidx desc
			</if>
			<if test="sort==4">
				order by price asc, pidx desc
			</if>
		</if>
	</sql>
</mapper>













